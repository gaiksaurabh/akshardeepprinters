<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cost Estimation Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        html, body {
            height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f4f8;
        }
        body {
            display: flex; flex-direction: column; padding: 1.5rem; box-sizing: border-box; align-items: center;
        }
        .container {
            width: 100%; max-width: 1300px; flex-grow: 1; display: flex; flex-direction: column;
        }
        h1 {
            text-align: center; color: #1a253c; margin-bottom: 1rem; flex-shrink: 0;
            /* Made title smaller per request */
            font-size: 1.3rem;
            font-weight: 600;
        }
        .top-bar {
            display: flex; flex-wrap: wrap; align-items: center; gap: 1rem;
            background-color: #ffffff; padding: 1rem 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07); margin-bottom: 1.5rem;
        }
        .top-bar .form-group { flex-grow: 1; min-width: 200px; }
        .total-display-top { text-align: right; min-width: 180px; }
        .total-display-top .total-label { font-size: 1rem; margin: 0 0 0.25rem 0; opacity: 0.9; color: #495057; font-weight: 500;}
        .total-display-top .total-value { font-size: 2.2rem; font-weight: bold; margin: 0; color: #1a253c; }
        .icon-btn {
            background: #f0f4f8; border: 1px solid #ced4da; border-radius: 8px; width: 45px; height: 45px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.15s, transform 0.08s;
        }
        .icon-btn:hover { background: #e2e6ea; transform: translateY(-1px); }
        .icon-btn svg { width: 22px; height: 22px; }
        #prev-estimates-btn { background: #007bff; border-color: #007bff; color: white; padding: 0 1rem; width: auto; font-weight: 500; font-size: 0.9rem; border-radius: 8px; height: 40px; display:flex; align-items:center; gap:0.5rem;}
        #prev-estimates-btn:hover { background: #0056b3; }
        .sections-wrapper {
            display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; flex-grow: 1;
        }
        .section {
            background-color: #ffffff; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07); display: flex; flex-direction: column;
        }
        .section-title {
            font-size: 1.3rem; color: #0066cc; margin-top: 0; margin-bottom: 1.5rem; border-bottom: 2px solid #e9ecef; padding-bottom: 0.5rem;
        }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem 1.5rem; }
        .form-grid-single-col { grid-template-columns: 1fr; }
        .grid-col-span-2 { grid-column: span 2; }
        .form-group { display: flex; flex-direction: column; justify-content: flex-end; }
        .form-group label, .label-with-checkbox { margin-bottom: 0.5rem; font-weight: 500; color: #495057; font-size: 0.9rem; }
        .form-group select, .form-group input { width: 100%; padding: 0.65rem; border: 1px solid #ced4da; border-radius: 8px; font-size: 0.95rem; box-sizing: border-box; background-color: #f8f9fa; }
        .input-group-inline { display: flex; align-items: flex-end; gap: 0.5rem; }
        .input-group-inline .form-group { flex-grow: 1; }
        .inline-checkbox { display: flex; align-items: center; gap: 0.5rem; }
        .inline-checkbox input { width: auto; }
        .inline-checkbox label { margin: 0; font-weight: normal; }
        .label-with-checkbox { display: flex; justify-content: space-between; align-items: center; }
        
        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.15s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; position: relative; }
        .modal-close { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        .estimates-list { list-style: none; padding: 0; margin: 0; }
        .estimates-list li { padding: 0.6rem 0.4rem; border-bottom: 1px solid #e9ecef; cursor: pointer; transition: background-color 0.2s; display:flex; align-items:center; justify-content:space-between; gap: 0.5rem; }
        .estimates-list li:hover { background-color: #f8f9fa; }
        .estimates-list li:last-child { border-bottom: none; }
        .estimate-name { flex-grow: 1; padding-right: 0.5rem; text-transform: none; color: #1a253c; font-weight: 600; }
        .delete-estimate-btn { background: transparent; border: none; color: #d9534f; font-size: 1.2rem; cursor: pointer; padding: 6px 8px; border-radius: 6px; }
        .delete-estimate-btn:hover { background: rgba(217,83,79,0.08); }

        @media (max-width: 1200px) { .sections-wrapper { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .top-bar { flex-direction: column; align-items: stretch; } }
    </style>
</head>
<body>
    <div id="modal-container"></div>
    <div class="container">
        <h1>Akshardeep Cost Estimation</h1>
        <div class="top-bar">
            <div class="form-group">
                <label for="customer-name">Customer Name</label>
                <input type="text" id="customer-name" placeholder="Enter customer name...">
            </div>
             <div class="total-display-top">
                <h3 class="total-label">Grand Total</h3>
                <p class="total-value" id="total-cost">₹ 0.00</p>
            </div>
            <button id="prev-estimates-btn" class="icon-btn">Past Estimates</button>
            <button id="download-pdf-btn" class="icon-btn" title="Download PDF"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 16.586l-4.293-4.293-1.414 1.414L12 19.414l5.707-5.707-1.414-1.414z"/></svg></button>
            <button id="whatsapp-btn" class="icon-btn" title="Send to WhatsApp"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="#25D366"><path d="M380.9 97.1C339 55.1 283.2 32 223.6 32 100.3 32 0 132.7 0 256c0 45 12 88.1 34.8 125.8L0 480l101.1-33.5C140.6 458 181.5 472 224 472 347.3 472 448 371.3 448 248c0-59.6-23.1-115.5-67.1-150.9z"/></svg></button>
<button id="save-btn" class="icon-btn" title="Save Estimate">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
    </svg>
</button>
        </div>
        <div class="sections-wrapper">
            <div class="section">
                <h2 class="section-title">1. Printing</h2>
                <div class="form-grid">
                    <div class="form-group grid-col-span-2">
                        <label for="job-size">Job Size</label>
                        <select id="job-size">
                            <option value="">Select Size</option>
                            <option value="10X15">10X15</option>
                            <option value="12X18">12X18</option>
                            <option value="18X23">18X23</option>
                            <option value="18X25">18X25</option>
                            <option value="15X20">15X20</option>
                            <option value="19X25">19X25</option>
                            <option value="20X28">20X28</option>
                        </select>
                    </div>
                    <div class="form-group"><label for="printing-gsm-select">GSM</label><select id="printing-gsm-select"></select></div>
                    <div class="form-group">
                        <label for="quantity">Quantity</label>
                        <div class="input-group-inline">
                            <input type="number" id="quantity" placeholder="e.g., 2000" style="flex-grow:1; margin:0;">
                            <div class="inline-checkbox" style="padding-bottom: 0.2rem;"><input type="checkbox" id="fb-check"><label for="fb-check">F/B</label></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="label-with-checkbox">
                           <label for="printing-cost" style="margin:0;">Printing Cost (₹)</label>
                           <div class="inline-checkbox"><input type="checkbox" id="without-plate-check"><label for="without-plate-check">Without Plate</label></div>
                        </div>
                        <input type="number" class="cost-input" id="printing-cost" placeholder="0.00" data-label="Printing Cost">
                    </div>
                    <div class="form-group"><label for="second-cost">Second (₹)</label><input type="number" class="cost-input" id="second-cost" placeholder="0.00" data-label="Second Printing"></div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">2. Paper</h2>
                <div class="form-grid">
                    <div class="form-group"><label for="paper-size-select">Paper Size</label><select id="paper-size-select"></select></div>
                    <div class="form-group"><label for="paper-gsm-select">Paper GSM</label><select id="paper-gsm-select"></select></div>
                    <div class="form-group"><label for="paper-sheets-input">No. of Sheets</label><input type="number" id="paper-sheets-input" placeholder="0"></div>
                    <div class="form-group"><label for="paper-rate-input">Rate per kg (₹)</label><input type="number" id="paper-rate-input" placeholder="e.g., 85"></div>
                    <div class="form-group grid-col-span-2">
                        <div class="label-with-checkbox">
                            <label for="paper-cost" style="margin:0;">Paper Cost (₹)</label>
                            <div class="inline-checkbox"><input type="checkbox" id="gst-checkbox"><label for="gst-checkbox">Without GST</label></div>
                        </div>
                        <input type="number" class="cost-input" id="paper-cost" placeholder="0.00" data-label="Paper Cost">
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">3. Lamination</h2>
                <div class="form-grid form-grid-single-col">
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group"><label for="lamination-type">Lamination</label><select id="lamination-type"><option value="">None</option><option value="gloss">Gloss</option><option value="matte">Matte</option></select></div>
                        <div class="form-group"><label for="lami-size">Lamination Size</label><select id="lami-size"><option value="">Select Size</option><option value="12x18">12x18</option><option value="20x28">20x28</option></select></div>
                    </div>
                    <div class="form-group"><label for="lami-cost">Lamination Cost (₹)</label><input type="number" class="cost-input" id="lami-cost" placeholder="0.00" data-label="Lamination Cost"></div>
                </div>
            </div>
            
            <div class="section">
                <h2 class="section-title">4. Other Costs</h2>
                <div class="form-grid">
                    <div class="form-group"><label for="binding-cost">Binding Cost (₹)</label><input type="number" class="cost-input" id="binding-cost" placeholder="0.00" data-label="Binding Cost"></div>
                    <div class="form-group"><label for="other-misc-cost">Other Costs (₹)</label><input type="number" class="cost-input" id="other-misc-cost" placeholder="0.00" data-label="Other Cost"></div>
                    <div class="form-group"><label for="punching-cost">Punching (₹)</label><input type="number" class="cost-input" id="punching-cost" placeholder="0.00" data-label="Punching"></div>
                    <div class="form-group"><label for="clips-cost">Clips (₹)</label><input type="number" class="cost-input" id="clips-cost" placeholder="0.00" data-label="Clips"></div>
                    <div class="form-group"><label for="envelope-size">Envelope Size</label><select id="envelope-size"><option value="">None</option><option value="9x4">9x4</option><option value="9x5">9x5</option></select></div>
                    <div class="form-group"><label for="env-cost">Envelope Cost (₹)</label><input type="number" class="cost-input" id="env-cost" placeholder="0.00" data-label="Envelope Cost"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', async () => {
    // --- DATA STORE ---
    let appData = {};

    // --- ELEMENT SELECTORS ---
    const allInputs = document.querySelectorAll('input, select');
    const customerNameInput = document.getElementById('customer-name');
    const allCostInputs = document.querySelectorAll('.cost-input');
    const totalCostDisplay = document.getElementById('total-cost');
    const jobSizeSelect = document.getElementById('job-size');
    const quantityInput = document.getElementById('quantity');
    const fbCheck = document.getElementById('fb-check');
    const withoutPlateCheck = document.getElementById('without-plate-check');
    const printingCostInput = document.getElementById('printing-cost');
    const secondCostInput = document.getElementById('second-cost');
    const printingGsmSelect = document.getElementById('printing-gsm-select');
    const paperGsmSelect = document.getElementById('paper-gsm-select');
    const paperSizeSelect = document.getElementById('paper-size-select');
    const paperSheetsInput = document.getElementById('paper-sheets-input');
    const paperRateInput = document.getElementById('paper-rate-input');
    const gstCheckbox = document.getElementById('gst-checkbox');
    const paperCostInput = document.getElementById('paper-cost');
    const laminationTypeSelect = document.getElementById('lamination-type');
    const laminationSizeSelect = document.getElementById('lami-size');
    const laminationCostInput = document.getElementById('lami-cost');
    const downloadPdfBtn = document.getElementById('download-pdf-btn');
    const whatsappBtn = document.getElementById('whatsapp-btn');
    const prevEstimatesBtn = document.getElementById('prev-estimates-btn');
    const saveBtn = document.getElementById('save-btn');
    const resetBtn = document.getElementById('reset-btn');
    const modalContainer = document.getElementById('modal-container');
    const ESTIMATE_PREFIX = 'akshardeep_estimate_';

    // --- DATA LOADING & INITIALIZATION ---
    async function loadAppData() {
        try {
            const response = await fetch('data.json');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            appData = await response.json();
            console.log("Application data loaded successfully!");
        } catch (error) {
            console.error("Could not load application data:", error);
        }
    }

    function initializeApp() {
        populatePaperSizes();
        populateStaticGsmDropdowns();
        setupEventListeners();
        calculateAllCosts();
    }
    
    // --- CALCULATION FUNCTIONS ---
    function calculateGrandTotal() {
        let total = 0;
        allCostInputs.forEach(input => { total += parseFloat(input.value) || 0; });
        const roundedTotal = Math.ceil(total / 50) * 50;
        totalCostDisplay.textContent = `₹ ${roundedTotal.toFixed(2)}`;
    }

    function calculatePrintingCosts() {
        const selectedGsm = String(printingGsmSelect.value).toUpperCase();
        const selectedSize = jobSizeSelect.value;
        const isWithoutPlate = withoutPlateCheck.checked;
        const heavyGsmList = ['300', '350', 'DUPLEX'];
        const smallSizes = ['10X15', '12X18'];
        const mediumSizes = ['15X20', '18X23', '18X25'];
        const largeHeavySizes = ['19X25', '20X28'];
        
        let rates;
        const rateType = appData.printingRates ? (isWithoutPlate ? appData.printingRates.withoutPlate : appData.printingRates.withPlate) : null;

        if (!rateType) {
            printingCostInput.value = "0.00";
            secondCostInput.value = "0.00";
            calculateGrandTotal();
            return;
        }

        if (smallSizes.includes(selectedSize)) { rates = rateType.small; } 
        else if (heavyGsmList.includes(selectedGsm)) {
            if (isWithoutPlate) { rates = rateType.largeHeavy; } 
            else {
                if (mediumSizes.includes(selectedSize)) rates = rateType.medium;
                else if (largeHeavySizes.includes(selectedSize)) rates = rateType.largeHeavy;
                else rates = rateType.large;
            }
        } else {
            rates = mediumSizes.includes(selectedSize) ? (isWithoutPlate ? rateType.large : rateType.medium) : rateType.large;
        }

        if (!rates) {
            printingCostInput.value = "0.00";
            secondCostInput.value = "0.00";
        } else {
            printingCostInput.value = (rates.cost || 0).toFixed(2);
            const baseQuantity = parseFloat(quantityInput.value) || 0;
            const isFbChecked = fbCheck.checked;
            const effectiveQuantity = isFbChecked ? baseQuantity * 2 : baseQuantity;
            let secondCost = 0;
            if (effectiveQuantity > 1000) {
                const exceedingQuantity = effectiveQuantity - 1000;
                const blocks = Math.ceil(exceedingQuantity / 1000);
                secondCost = blocks * (rates.secondRate || 0);
            }
            secondCostInput.value = secondCost.toFixed(2);
        }
        calculateGrandTotal();
    }

    function calculatePaperCost() {
        const selectedSize = paperSizeSelect.value;
        const selectedGsm = paperGsmSelect.value;
        const sheets = parseFloat(paperSheetsInput.value) || 0;
        const rate = parseFloat(paperRateInput.value) || 0;
        const withoutGst = gstCheckbox.checked;

        if (!selectedSize || !selectedGsm || !sheets || !rate) {
            paperCostInput.value = "0.00";
            calculateGrandTotal();
            return;
        }

        const paperInfo = appData.paperData ? appData.paperData.find(d => d.size.toLowerCase() === selectedSize.toLowerCase() && String(d.gsm).toLowerCase() === selectedGsm.toLowerCase()) : null;
        const perSheetWeight = paperInfo ? paperInfo.perSheetWeight : 0;
        const basePrice = perSheetWeight * sheets * rate;
        const gstRate = withoutGst ? 0.06 : 0.12;
        const finalPrice = basePrice * (1 + gstRate);
        const roundedPaperCost = Math.ceil(finalPrice / 50) * 50;
        paperCostInput.value = roundedPaperCost.toFixed(2);
        calculateGrandTotal();
    }

    function calculateNumberOfSheets() {
        const jobSize = jobSizeSelect.value;
        const quantity = parseFloat(quantityInput.value) || 0;
        const paperGsm = String(paperGsmSelect.value).toUpperCase();
        let divisionFactor = 0;
        if (jobSize === '20X28') { divisionFactor = 1; } 
        else if (jobSize === '12X18' || jobSize === '10X15') { divisionFactor = (paperGsm === 'STICKER') ? 2 : 4; } 
        else if (jobSize) { divisionFactor = (paperGsm === 'STICKER') ? 1 : 2; }
        const sheets = (divisionFactor > 0) ? Math.ceil(quantity / divisionFactor) : 0;
        paperSheetsInput.value = sheets;
        calculatePaperCost();
    }
    
    function calculateAllCosts() {
        calculateNumberOfSheets();
        calculatePrintingCosts();
    }

    // --- UI & HELPER FUNCTIONS ---
    function syncGsm(sourceSelect, targetSelect) {
        if (sourceSelect.value) {
            targetSelect.value = sourceSelect.value;
            targetSelect.dispatchEvent(new Event('change'));
        }
    }

    function sendToWhatsApp() {
        const customer = customerNameInput.value || 'Customer';
        const total = totalCostDisplay.textContent;
        const summary = getSummaryData();
        let message = `Hello ${customer},\n\nHere is your cost estimate:\n\n`;
        message += `${summary.jobSize}\n`;
        message += `${summary.quantity}\n`;
        message += `${summary.gsm}\n\n`;
        summary.items.forEach(item => { message += `*${item.label}:* ${item.cost.toFixed(2)} ₹\n`; });
        message += `\n*Grand Total:* ${total}`;
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
    }

    // --- PDF GENERATION (MODIFIED) ---
    function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const customerName = customerNameInput.value || 'Valued Customer';
        const estimateNr = customerName.replace(/\s/g, '_') || 'current';
        const today = new Date().toLocaleDateString('en-GB');

        // Page Header
        doc.setFontSize(20);
        doc.setFont("helvetica", "bold");
        doc.text("Cost Estimate", 105, 20, { align: 'center' });

        // Metadata
        doc.setFontSize(11);
        doc.setFont("helvetica", "normal");
        doc.text(`Cost estimate Nr.: ${estimateNr}`, 14, 35);
        doc.text(`Date: ${today}`, 148, 35);

        // Salutation and Introduction
        doc.text(`Dear ${customerName},`, 14, 50);
        doc.text("We thank you for your enquiry and would like to make the following offer:", 14, 57);

        // Single-line Job Description
        const jobSize = jobSizeSelect.value || 'N/A';
        const gsm = printingGsmSelect.value || 'N/A';
        const quantity = quantityInput.value || '0';
        const fb = fbCheck.checked ? ' F/B' : '';
        const singleLineDescription = `${jobSize} - ${gsm} GSM - ${quantity}${fb}`;
        
        doc.setFont("helvetica", "bold");
        doc.text(singleLineDescription, 14, 67);
        doc.setFont("helvetica", "normal");

        // Table Data Preparation
        const tableBody = [];
        let pos = 1;
        let subtotal = 0;

        const costItems = [
            { label: 'Printing Cost', value: parseFloat(printingCostInput.value) || 0 },
            { label: 'Second Printing', value: parseFloat(secondCostInput.value) || 0 },
            { label: 'Paper Cost', value: parseFloat(paperCostInput.value) || 0 },
            { label: 'Lamination Cost', value: parseFloat(laminationCostInput.value) || 0 },
            { label: 'Binding Cost', value: parseFloat(document.getElementById('binding-cost').value) || 0 },
            { label: 'Punching', value: parseFloat(document.getElementById('punching-cost').value) || 0 },
            { label: 'Clips', value: parseFloat(document.getElementById('clips-cost').value) || 0 },
            { label: 'Envelope Cost', value: parseFloat(document.getElementById('env-cost').value) || 0 },
            { label: 'Other Costs', value: parseFloat(document.getElementById('other-misc-cost').value) || 0 }
        ];

        costItems.forEach(item => {
            if (item.value > 0) {
                tableBody.push([
                    pos++,
                    item.label,
                    '1',
                    'Item',
                    item.value.toFixed(2),
                    item.value.toFixed(2)
                ]);
                subtotal += item.value;
            }
        });

        // AutoTable Generation
        doc.autoTable({
            head: [['Pos.', 'Designation', 'Quantity', 'Unit', 'Single price', 'Total price']],
            body: tableBody,
            startY: 75,
            theme: 'grid',
            headStyles: { fillColor: [22, 160, 133], textColor: [255, 255, 255] },
            columnStyles: {
                0: { halign: 'center', cellWidth: 15 },
                1: { halign: 'left' },
                2: { halign: 'right' },
                3: { halign: 'left' },
                4: { halign: 'right' },
                5: { halign: 'right' }
            }
        });

        // Footer with Total
        let finalY = doc.lastAutoTable.finalY;
        const total = Math.ceil(subtotal / 50) * 50;
        doc.setFontSize(12);
        doc.setFont("helvetica", "bold");
        doc.text('Total', 145, finalY + 10);
        doc.text(`₹ ${total.toFixed(2)}`, 196, finalY + 10, { align: 'right' });

        // Terms
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        const validUntil = new Date();
        validUntil.setDate(validUntil.getDate() + 15);
        doc.text(`This offer is valid until ${validUntil.toLocaleDateString('en-GB')}.`, 14, doc.internal.pageSize.height - 20);
        doc.text("We hope you will approve and look forward to working with you.", 14, doc.internal.pageSize.height - 13);
        
        doc.save(`Cost-Estimate-${estimateNr}.pdf`);
    }

    // --- SAVE/LOAD FUNCTIONS (LOCALSTORAGE) ---
    function saveEstimate() {
        const customerName = customerNameInput.value.trim();
        if (!customerName) {
            alert("Please enter a customer name to save the estimate.");
            return;
        }
        const estimateKey = ESTIMATE_PREFIX + customerName.toLowerCase().replace(/\s+/g, '_');
        const estimateData = {};
        allInputs.forEach(input => {
            if(input.id) { estimateData[input.id] = (input.type === 'checkbox') ? input.checked : input.value; }
        });
        estimateData._savedAt = new Date().toISOString();
        localStorage.setItem(estimateKey, JSON.stringify(estimateData));
        alert(`Estimate for "${customerName}" has been saved!`);
    }

    function loadEstimate(estimateKey) {
        const dataString = localStorage.getItem(estimateKey);
        if(dataString) {
            try {
                const estimateData = JSON.parse(dataString);
                allInputs.forEach(input => {
                    if(input.id && estimateData[input.id] !== undefined) {
                        if(input.type === 'checkbox') { input.checked = estimateData[input.id]; } 
                        else { input.value = estimateData[input.id]; }
                        if (input.tagName === 'SELECT') {
                             input.dispatchEvent(new Event('change'));
                        }
                    }
                });
                calculateAllCosts();
                closeModal();
                alert(`Loaded estimate for "${estimateData['customer-name'] || ''}"`);
            } catch (e) {
                console.error("Failed to parse estimate data", e);
                alert("Failed to load estimate (corrupted data).");
            }
        }
    }
    
    function deleteEstimate(estimateKey) {
         const friendlyName = (localStorage.getItem(estimateKey)) ? (() => {
             try { const d = JSON.parse(localStorage.getItem(estimateKey)); return d && d['customer-name'] ? d['customer-name'] : estimateKey.replace(ESTIMATE_PREFIX, ''); } catch(e){ return estimateKey.replace(ESTIMATE_PREFIX,''); }
         })() : estimateKey.replace(ESTIMATE_PREFIX, '');
         if (confirm(`Are you sure you want to delete the estimate for "${friendlyName}"? This cannot be undone.`)) {
            localStorage.removeItem(estimateKey);
            showPreviousEstimates();
        }
    }
    
    function showPreviousEstimates() {
        const estimates = Object.keys(localStorage)
            .filter(key => key.startsWith(ESTIMATE_PREFIX))
            .sort((a,b) => {
                const aItem = (() => { try { return JSON.parse(localStorage.getItem(a))['customer-name'] || a.replace(ESTIMATE_PREFIX,''); } catch(e){ return a.replace(ESTIMATE_PREFIX,''); } })();
                const bItem = (() => { try { return JSON.parse(localStorage.getItem(b))['customer-name'] || b.replace(ESTIMATE_PREFIX,''); } catch(e){ return b.replace(ESTIMATE_PREFIX,''); } })();
                return aItem.toLowerCase().localeCompare(bItem.toLowerCase());
            });
        
        let listHtml = '<ul class="estimates-list">';
        if(estimates.length > 0) {
            estimates.forEach(key => {
                let displayName = key.replace(ESTIMATE_PREFIX, '');
                try {
                    const raw = localStorage.getItem(key);
                    if (raw) {
                        const parsed = JSON.parse(raw);
                        if (parsed && parsed['customer-name']) displayName = parsed['customer-name'];
                    }
                } catch(e) { /* ignore parse errors */ }
                listHtml += `<li class="estimate-item">
                                 <span class="estimate-name" data-key="${key}">${displayName}</span>
                                 <button class="delete-estimate-btn" data-key="${key}" title="Delete estimate">✕</button>
                               </li>`;
            });
        } else {
            listHtml += '<li>No saved estimates found.</li>';
        }
        listHtml += '</ul>';
        const modalHtml = `<div class="modal-overlay active"><div class="modal-content"><button class="modal-close" title="Close">&times;</button><h2>Previous Estimates</h2>${listHtml}</div></div>`;
        modalContainer.innerHTML = modalHtml;
    }
    
    function closeModal() { modalContainer.innerHTML = ''; }
    
    function populatePaperSizes() {
        if (!appData.paperData) return;
        const uniqueSizes = [...new Set(appData.paperData.map(item => item.size.toUpperCase()))];
        paperSizeSelect.innerHTML = '<option value="">Select Size</option>';
        uniqueSizes.sort().forEach(size => { paperSizeSelect.innerHTML += `<option value="${size}">${size}</option>`; });
    }

    function populateStaticGsmDropdowns() {
        if (!appData.paperData) return;
        const allGsm = [...new Set(appData.paperData.map(item => item.gsm))];
        allGsm.sort((a, b) => {
            const aIsString = isNaN(a); const bIsString = isNaN(b);
            if (aIsString && !bIsString) return -1; if (!aIsString && bIsString) return 1;
            if (aIsString && bIsString) return a.localeCompare(b);
            return a - b;
        });
        printingGsmSelect.innerHTML = '<option value="">Select GSM</option>';
        paperGsmSelect.innerHTML = '<option value="">Select GSM</option>';
        allGsm.forEach(gsm => {
            const option = `<option value="${gsm}">${gsm}</option>`;
            printingGsmSelect.innerHTML += option;
            paperGsmSelect.innerHTML += option;
        });
    }
    
    function resetForm() {
        if (confirm("Are you sure you want to reset the form? All unsaved data will be lost.")) {
            allInputs.forEach(input => {
                if (input.type === 'checkbox') input.checked = false;
                else if (input.tagName === 'SELECT') input.selectedIndex = 0;
                else input.value = '';
            });
            allCostInputs.forEach(input => input.value = "0.00");
            paperSheetsInput.value = '0';
            calculateAllCosts();
        }
    }

    // --- EVENT LISTENERS SETUP ---
    function setupEventListeners() {
        modalContainer.addEventListener('click', (e) => {
            if(e.target.classList.contains('modal-overlay') || e.target.classList.contains('modal-close')) { closeModal(); }
            if(e.target.classList.contains('estimate-name') && e.target.dataset.key) { loadEstimate(e.target.dataset.key); }
            if(e.target.classList.contains('delete-estimate-btn')) {
                e.stopPropagation();
                if(e.target.dataset.key) deleteEstimate(e.target.dataset.key);
            }
        });

        if (resetBtn) resetBtn.addEventListener('click', resetForm);
        if (saveBtn) saveBtn.addEventListener('click', saveEstimate);
        if (downloadPdfBtn) downloadPdfBtn.addEventListener('click', generatePDF);
        if (whatsappBtn) whatsappBtn.addEventListener('click', sendToWhatsApp);
        if (prevEstimatesBtn) prevEstimatesBtn.addEventListener('click', showPreviousEstimates);

        allCostInputs.forEach(input => input.addEventListener('input', calculateGrandTotal));
        
        const printingTriggers = [jobSizeSelect, quantityInput, fbCheck, withoutPlateCheck, printingGsmSelect];
        printingTriggers.forEach(el => { if (el) el.addEventListener('change', calculatePrintingCosts); });
        if (quantityInput) quantityInput.addEventListener('input', calculatePrintingCosts);
        
        if (printingGsmSelect) printingGsmSelect.addEventListener('change', () => syncGsm(printingGsmSelect, paperGsmSelect));
        if (paperGsmSelect) paperGsmSelect.addEventListener('change', () => syncGsm(paperGsmSelect, printingGsmSelect));
        
        const paperTriggers = [paperSizeSelect, paperGsmSelect, paperSheetsInput, paperRateInput, gstCheckbox];
        paperTriggers.forEach(el => { if (el) el.addEventListener('change', calculatePaperCost); });
        [paperSheetsInput, paperRateInput].forEach(el => { if (el) el.addEventListener('input', calculatePaperCost); });
        
        const sheetTriggers = [jobSizeSelect, quantityInput, paperGsmSelect];
        sheetTriggers.forEach(el => { if (el) el.addEventListener('change', calculateNumberOfSheets); });
        if (quantityInput) quantityInput.addEventListener('input', calculateNumberOfSheets);
    }
    
    // --- APP START ---
    await loadAppData();
    initializeApp();
});
</script>
</body>
</html>
