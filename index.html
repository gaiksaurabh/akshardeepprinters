<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akshardeep Cost Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        html, body {
            height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f4f8;
        }
        body {
            display: flex; flex-direction: column; padding: 1.5rem; box-sizing: border-box; align-items: center;
        }
        .container {
            width: 100%; max-width: 1300px; flex-grow: 1; display: flex; flex-direction: column;
        }
        h1 {
            text-align: center; color: #1a253c; margin-bottom: 1rem; flex-shrink: 0;
            font-size: 1.5rem; /* Increased size */
            font-weight: 700; /* Bolder */
        }
        .top-bar {
            display: flex; flex-wrap: wrap; align-items: center; gap: 1rem;
            background-color: #ffffff; padding: 1rem 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07); margin-bottom: 1.5rem;
        }
        .top-bar .form-group { flex-grow: 1; min-width: 200px; }
        .total-display-top { text-align: right; min-width: 180px; }
        .total-display-top .total-label { font-size: 1rem; margin: 0 0 0.25rem 0; opacity: 0.9; color: #495057; font-weight: 500;}
        .total-display-top .total-value { font-size: 2.2rem; font-weight: bold; margin: 0; color: #1a253c; }
        .icon-btn {
            background: #f0f4f8; border: 1px solid #ced4da; border-radius: 8px; width: 45px; height: 45px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.15s, transform 0.08s;
        }
        .icon-btn:hover { background: #e2e6ea; transform: translateY(-1px); }
        .icon-btn svg { width: 22px; height: 22px; }
        .icon-group { display: flex; gap: 1rem; margin-left: auto; }
        .sections-wrapper {
            display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; flex-grow: 1;
        }
        .section {
            background-color: #ffffff; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07); display: flex; flex-direction: column;
        }
        .section-title-container {
             display: flex; justify-content: space-between; align-items: center;
             border-bottom: 2px solid #e9ecef; padding-bottom: 0.5rem; margin-bottom: 1.5rem;
        }
        .section-title {
            font-size: 1.3rem; color: #0066cc; margin: 0;
        }
        .utility-btn {
            background: #e7f5ff; border: 1px solid #99cfff; color: #0066cc;
            font-size: 0.8rem; font-weight: 600; padding: 0.3rem 0.8rem; border-radius: 20px;
            cursor: pointer; transition: all 0.2s ease;
        }
        .utility-btn:hover { background: #d0ebff; border-color: #66b3ff; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem 1.5rem; }
        .form-grid-single-col { grid-template-columns: 1fr; }
        .grid-col-span-2 { grid-column: span 2; }
        .form-group { display: flex; flex-direction: column; justify-content: flex-end; }
        .form-group label, .label-with-checkbox { margin-bottom: 0.5rem; font-weight: 500; color: #495057; font-size: 0.9rem; }
        .form-group select, .form-group input { width: 100%; padding: 0.65rem; border: 1px solid #ced4da; border-radius: 8px; font-size: 0.95rem; box-sizing: border-box; background-color: #f8f9fa; }
        .input-group-inline { display: flex; align-items: flex-end; gap: 1rem; } /* Increased gap slightly */
        .inline-checkbox { display: flex; align-items: center; gap: 0.3rem; white-space: nowrap; }
        .inline-checkbox input { width: auto; transform: scale(1.1); cursor: pointer; }
        .inline-checkbox label { margin: 0; font-weight: normal; cursor: pointer; }
        .label-with-checkbox { display: flex; justify-content: space-between; align-items: center; }
        
        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.15s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; position: relative; }
        .modal-close { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #888; }
        .modal-close:hover { color: #333; }
        .modal-content h2 { margin-top: 0; color: #1a253c; }

        .estimates-list { list-style: none; padding: 0; margin: 0; }
        .estimates-list li { padding: 0.6rem 0.4rem; border-bottom: 1px solid #e9ecef; cursor: pointer; transition: background-color 0.2s; display:flex; align-items:center; justify-content:space-between; gap: 0.5rem; }
        .estimates-list li:hover { background-color: #f8f9fa; }
        .estimates-list li:last-child { border-bottom: none; }
        .estimate-name { flex-grow: 1; padding-right: 0.5rem; text-transform: none; color: #1a253c; font-weight: 600; }
        .delete-estimate-btn { background: transparent; border: none; color: #d9534f; font-size: 1.2rem; cursor: pointer; padding: 6px 8px; border-radius: 6px; }
        .delete-estimate-btn:hover { background: rgba(217,83,79,0.08); }
        
        #weight-calculator-result {
            margin-top: 1.5rem;
            text-align: center;
            padding: 1rem;
            border-radius: 8px;
            background-color: #f0f4f8;
            border: 1px solid #d1d9e6;
        }
        #weight-calculator-result p { margin: 0; }
        #weight-calculator-result .result-label { font-size: 0.9rem; color: #495057; }
        #weight-calculator-result .result-value { font-size: 1.8rem; font-weight: bold; color: #1a253c; }

        @media (max-width: 1200px) { .sections-wrapper { grid-template-columns: 1fr; } }
        @media (max-width: 768px) {
            .top-bar { flex-direction: column; align-items: stretch; }
            .icon-group { justify-content: center; margin-left: 0; padding-top: 0.5rem; }
        }
    </style>
</head>
<body>
    <div id="modal-container"></div>
    <div class="container">
        <h1>Akshardeep Cost Estimation Tool</h1>
        <div class="top-bar">
            <div class="form-group">
                <label for="customer-name">Customer Name</label>
                <input type="text" id="customer-name" placeholder="Enter customer name...">
            </div>
            <div class="total-display-top">
                <h3 class="total-label">Total</h3>
                <p class="total-value" id="total-cost">₹ 0.00</p>
            </div>
            
            <div class="icon-group">
                <button id="download-pdf-btn" class="icon-btn" title="Download PDF & Save Estimate">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                </button>
                <button id="whatsapp-btn" class="icon-btn" title="Send to WhatsApp">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="#25D366"><path d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4 0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3 0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157zm-157 341.6c-33.8 0-67.6-9.5-97.8-26.7l-7-4.1-72.5 19.1 19.4-70.5-4.5-7.3c-18.4-29.4-28.2-63.3-28.2-98.2 0-101.7 82.8-184.5 184.6-184.5 49.3 0 95.6 19.2 130.4 54.1 34.8 34.9 56.2 81.2 56.1 130.5 0 101.8-84.9 184.6-186.6 184.6zm101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8-3.7 5.6-14.3 18-17.6 21.8-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7.9-6.9-.5-9.7-1.4-2.8-12.5-30.1-17.1-41.2-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2-3.7 0-9.7 1.4-14.8 6.9-5.1 5.6-19.4 19-19.4 46.3 0 27.3 19.9 53.7 22.6 57.4 2.8 3.7 39.1 59.7 94.8 83.8 35.2 15.2 49 16.5 66.6 13.9 10.7-1.6 32.8-13.4 37.4-26.4 4.6-13 4.6-24.1 3.2-26.4-1.3-2.5-5-3.9-10.5-6.6z"/></svg>
                </button>
                <button id="prev-estimates-btn" class="icon-btn" title="Past Estimates">
                    <svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" viewBox="0 0 24 24" fill="currentColor"><g><rect fill="none" height="24" width="24"/><path d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M12,20c-4.41,0-8-3.59-8-8s3.59-8,8-8 s8,3.59,8,8S16.41,20,12,20z M12.5,7H11v6l5.25,3.15l0.75-1.23l-4.5-2.67V7z"/></g></svg>
                </button>
            </div>
        </div>
        <div class="sections-wrapper">
            <div class="section">
                <div class="section-title-container"><h2 class="section-title">1. Printing</h2></div>
                <div class="form-grid">
                    <div class="form-group grid-col-span-2">
                        <label for="job-size">Job Size</label>
                        <select id="job-size">
                            <option value="">Select Size</option><option value="10X15">10X15</option><option value="12X18">12X18</option><option value="18X23">18X23</option><option value="18X25">18X25</option><option value="15X20">15X20</option><option value="19X25">19X25</option><option value="20X28">20X28</option>
                        </select>
                    </div>
                    <div class="form-group"><label for="printing-gsm-select">GSM</label><select id="printing-gsm-select"></select></div>
                    <div class="form-group">
                        <label for="quantity">Quantity</label>
                        <div class="input-group-inline">
                            <input type="number" id="quantity" placeholder="e.g., 2000" style="flex-grow:1; margin:0;">
                            <div class="inline-checkbox" style="padding-bottom: 0.2rem;">
                                <input type="checkbox" id="fb-check"><label for="fb-check">F/B</label>
                            </div>
                            <div class="inline-checkbox" style="padding-bottom: 0.2rem;">
                                <input type="checkbox" id="form-check"><label for="form-check">Form</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="label-with-checkbox">
                           <label for="printing-cost" style="margin:0;">Printing Cost (₹)</label>
                           <div class="inline-checkbox"><input type="checkbox" id="without-plate-check"><label for="without-plate-check">Without Plate</label></div>
                        </div>
                        <input type="number" class="cost-input" id="printing-cost" placeholder="" data-label="Printing Cost">
                    </div>
                    <div class="form-group"><label for="second-cost">Second (₹)</label><input type="number" class="cost-input" id="second-cost" placeholder="" data-label="Second Printing"></div>
                </div>
            </div>

            <div class="section">
                <div class="section-title-container">
                    <h2 class="section-title">2. Paper</h2>
                    <button id="open-weight-calculator-btn" class="utility-btn">Weight Calculator</button>
                </div>
                <div class="form-grid">
                    <div class="form-group"><label for="paper-size-select">Paper Size</label><select id="paper-size-select"></select></div>
                    <div class="form-group"><label for="paper-gsm-select">Paper GSM</label><select id="paper-gsm-select"></select></div>
                    <div class="form-group"><label for="paper-sheets-input">No. of Sheets</label><input type="number" id="paper-sheets-input" placeholder="0"></div>
                    <div class="form-group"><label for="paper-rate-input">Rate per kg (₹)</label><input type="number" id="paper-rate-input" placeholder="e.g., 85"></div>
                    <div class="form-group grid-col-span-2">
                        <div class="label-with-checkbox">
                            <label for="paper-cost" style="margin:0;">Paper Cost (₹)</label>
                            <div class="inline-checkbox"><input type="checkbox" id="gst-checkbox"><label for="gst-checkbox">Without GST</label></div>
                        </div>
                        <input type="number" class="cost-input" id="paper-cost" placeholder="0.00" data-label="Paper Cost">
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title-container"><h2 class="section-title">3. Lamination</h2></div>
                <div class="form-grid form-grid-single-col">
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group"><label for="lamination-type">Lamination</label><select id="lamination-type"><option value="">None</option><option value="gloss">Gloss</option><option value="matte">Matte</option></select></div>
                        <div class="form-group"><label for="lami-size">Lamination Size</label><select id="lami-size"><option value="">Select Size</option><option value="12x18">12x18</option><option value="20x28">20x28</option></select></div>
                    </div>
                    <div class="form-group"><label for="lami-cost">Lamination Cost (₹)</label><input type="number" class="cost-input" id="lami-cost" placeholder="0.00" data-label="Lamination Cost"></div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title-container"><h2 class="section-title">4. Other Costs</h2></div>
                <div class="form-grid">
                    <div class="form-group"><label for="binding-cost">Binding Cost (₹)</label><input type="number" class="cost-input" id="binding-cost" placeholder="0.00" data-label="Binding Cost"></div>
                    <div class="form-group"><label for="other-misc-cost">Other Costs (₹)</label><input type="number" class="cost-input" id="other-misc-cost" placeholder="0.00" data-label="Other Cost"></div>
                    <div class="form-group"><label for="punching-cost">Punching (₹)</label><input type="number" class="cost-input" id="punching-cost" placeholder="0.00" data-label="Punching"></div>
                    <div class="form-group"><label for="clips-cost">Clips (₹)</label><input type="number" class="cost-input" id="clips-cost" placeholder="0.00" data-label="Clips"></div>
                    <div class="form-group"><label for="envelope-size">Envelope Size</label><select id="envelope-size"><option value="">None</option><option value="9x4">9x4</option><option value="9x5">9x5</option><option value="9x6">9x6</option></select></div>
                    <div class="form-group"><label for="env-cost">Envelope Cost (₹)</label><input type="number" class="cost-input" id="env-cost" placeholder="0.00" data-label="Envelope Cost"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA STORE ---
        // For this self-contained example, data is embedded here.
        const appData = {
          "paperData": [
            {"size": "23X36", "gsm": 90, "perSheetWeight": 0.04808},
            {"size": "23X36", "gsm": 100, "perSheetWeight": 0.05342},
            {"size": "23X36", "gsm": 130, "perSheetWeight": 0.06945},
            {"size": "23X36", "gsm": 170, "perSheetWeight": 0.09082},
            {"size": "25X38", "gsm": 90, "perSheetWeight": 0.05514},
            {"size": "25X38", "gsm": 100, "perSheetWeight": 0.06127},
            {"size": "19X25", "gsm": "STICKER", "perSheetWeight": 0.045}
          ]
        };

        // --- ELEMENT SELECTORS ---
        const allInputs = document.querySelectorAll('input, select');
        const customerNameInput = document.getElementById('customer-name');
        const allCostInputs = document.querySelectorAll('.cost-input');
        const totalCostDisplay = document.getElementById('total-cost');
        const jobSizeSelect = document.getElementById('job-size');
        const quantityInput = document.getElementById('quantity');
        const fbCheck = document.getElementById('fb-check');
        const formCheck = document.getElementById('form-check'); // NEW CHECKBOX
        const withoutPlateCheck = document.getElementById('without-plate-check');
        const printingCostInput = document.getElementById('printing-cost');
        const secondCostInput = document.getElementById('second-cost');
        const paperSheetsInput = document.getElementById('paper-sheets-input');
        const paperCostInput = document.getElementById('paper-cost');
        const paperSizeSelect = document.getElementById('paper-size-select');
        const paperGsmSelect = document.getElementById('paper-gsm-select');
        const printingGsmSelect = document.getElementById('printing-gsm-select');
        const paperRateInput = document.getElementById('paper-rate-input');
        const gstCheckbox = document.getElementById('gst-checkbox');
        const laminationTypeSelect = document.getElementById('lamination-type');
        const laminationSizeSelect = document.getElementById('lami-size');
        const lamiCostInput = document.getElementById('lami-cost');
        const bindingCostInput = document.getElementById('binding-cost');
        const otherMiscCostInput = document.getElementById('other-misc-cost');
        const punchingCostInput = document.getElementById('punching-cost');
        const clipsCostInput = document.getElementById('clips-cost');
        const envelopeSizeSelect = document.getElementById('envelope-size');
        const envCostInput = document.getElementById('env-cost');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const whatsappBtn = document.getElementById('whatsapp-btn');
        const prevEstimatesBtn = document.getElementById('prev-estimates-btn');
        const openWeightCalculatorBtn = document.getElementById('open-weight-calculator-btn');
        const modalContainer = document.getElementById('modal-container');
        const COUNTER_KEY = 'akshardeep_estimate_counter';

        // --- INITIALIZATION ---
        initializeApp();

        function initializeApp() {
            populateDropdowns();
            setupEventListeners();
            calculateAllCosts();
        }

        // --- CALCULATION FUNCTIONS ---
        function calculateGrandTotal() {
            let total = 0;
            allCostInputs.forEach(input => { total += parseFloat(input.value) || 0; });
            const roundedTotal = Math.ceil(total / 50) * 50;
            totalCostDisplay.textContent = `₹ ${roundedTotal.toFixed(2)}`;
        }

        // --- UPDATED PRINTING COST FUNCTION ---
        function calculatePrintingCosts() {
            const selectedGsm = printingGsmSelect.value;
            const selectedSize = jobSizeSelect.value;
            
            if (!selectedGsm || !selectedSize) {
                printingCostInput.value = ""; 
                secondCostInput.value = "";
                calculateGrandTotal(); 
                return;
            }

            const isWithoutPlate = withoutPlateCheck.checked;
            const isHeavyGsm = ['300', '350', 'DUPLEX'].includes(selectedGsm.toUpperCase());
            
            let baseCost = 0;
            let secondRate = 0;

            const standardLargeSizes = ['18X23', '18X25', '15X20', '19X25', '20X28'];
            const smallSizes = ['10X15', '12X18'];

            if (isHeavyGsm) {
                baseCost = 2400;
                secondRate = 600;
            } else if (standardLargeSizes.includes(selectedSize)) {
                baseCost = 1900;
                secondRate = 500;
            } else if (smallSizes.includes(selectedSize)) {
                baseCost = isWithoutPlate ? 700 : 1200;
                secondRate = 300;
            } else {
                baseCost = 0;
                secondRate = 0;
            }
            
            printingCostInput.value = baseCost.toFixed(2);
            
            // --- Second Cost Logic (Updated for Form Checkbox) ---
            if (formCheck.checked) {
                // If "Form" is checked, second cost equals printing cost
                secondCostInput.value = baseCost.toFixed(2);
            } else {
                // Standard Logic
                let secondCost = 0;
                const effectiveQuantity = fbCheck.checked ? (parseFloat(quantityInput.value) || 0) * 2 : (parseFloat(quantityInput.value) || 0);
                if (effectiveQuantity > 1000) {
                    secondCost = Math.ceil((effectiveQuantity - 1000) / 1000) * secondRate;
                }
                secondCostInput.value = secondCost.toFixed(2);
            }
            
            calculateGrandTotal();
        }

        function calculatePaperCost() {
            const sheets = parseFloat(paperSheetsInput.value) || 0;
            const rate = parseFloat(paperRateInput.value) || 0;

            if (!paperSizeSelect.value || !paperGsmSelect.value || !sheets || !rate) {
                paperCostInput.value = "0.00";
                paperCostInput.dispatchEvent(new Event('input'));
                return;
            }
            
            const paperInfo = appData.paperData?.find(d => d.size.toLowerCase() === paperSizeSelect.value.toLowerCase() && String(d.gsm).toLowerCase() === paperGsmSelect.value.toLowerCase());
            
            const basePrice = (paperInfo?.perSheetWeight || 0) * sheets * rate;
            const taxRate = gstCheckbox.checked ? 0 : 0.12;
            const finalPrice = basePrice * (1 + taxRate);
            
            paperCostInput.value = (Math.ceil(finalPrice / 50) * 50).toFixed(2);
            paperCostInput.dispatchEvent(new Event('input'));
        }

        function calculateNumberOfSheets() {
            const quantity = parseFloat(quantityInput.value) || 0;
            const paperGsm = paperGsmSelect.value.toUpperCase();
            let divisionFactor = 0;
            if (jobSizeSelect.value === '20X28') { divisionFactor = 1; } 
            else if (['12X18', '10X15'].includes(jobSizeSelect.value)) { divisionFactor = (paperGsm === 'STICKER') ? 2 : 4; } 
            else if (jobSizeSelect.value) { divisionFactor = (paperGsm === 'STICKER') ? 1 : 2; }
            
            const baseSheets = (divisionFactor > 0) ? Math.ceil(quantity / divisionFactor) : 0;
            paperSheetsInput.value = baseSheets > 0 ? baseSheets + 5 : 0;
            calculatePaperCost();
        }
        
        function calculateAllCosts() {
            calculateNumberOfSheets();
            calculatePrintingCosts();
        }

        // --- UI & HELPER FUNCTIONS ---
        function getDynamicDescription() {
            let desc = `${jobSizeSelect.value || 'N/A'} - ${printingGsmSelect.value || 'N/A'} GSM - ${quantityInput.value || '0'}`;
            if (fbCheck.checked) { desc += ' F/B'; }
            if (formCheck.checked) { desc += ' (Form)'; } // Add Form to description
            const lamiType = laminationTypeSelect.value;
            if (lamiType) {
                const lamiSize = laminationSizeSelect.value;
                const formattedLamiType = lamiType.charAt(0).toUpperCase() + lamiType.slice(1);
                desc += ` - ${formattedLamiType} (${lamiSize || 'N/A'})`;
            }
            const envSize = envelopeSizeSelect.value;
            if (envSize) { desc += ` - Envelope (${envSize})`; }
            return desc;
        }

        function syncGsm(source, target) {
            if (source.value) {
                target.value = source.value;
                target.dispatchEvent(new Event('change'));
            }
        }

        function sendToWhatsApp() {
            const customer = customerNameInput.value || 'Customer';
            const total = totalCostDisplay.textContent;
            const dynamicDescription = getDynamicDescription();
            let message = `Hello ${customer},\n\nHere is your cost estimate for:\n*${dynamicDescription}*\n\n*Total:* ${total}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
        }

        function generatePDF() {
            const customerName = customerNameInput.value.trim();
            if (!customerName) {
                alert("Please enter a customer name before creating a PDF."); return;
            }
            
            let counter = parseInt(localStorage.getItem(COUNTER_KEY)) || 0;
            counter++;
            const estimateNr = 'AOP' + String(counter).padStart(2, '0');
            
            const estimateData = {};
            allInputs.forEach(input => {
                if(input.id) estimateData[input.id] = input.type === 'checkbox' ? input.checked : input.value;
            });
            localStorage.setItem(estimateNr, JSON.stringify(estimateData));
            localStorage.setItem(COUNTER_KEY, counter);
            alert(`Estimate ${estimateNr} has been saved.`);

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const today = new Date().toLocaleDateString('en-GB');

            doc.setFontSize(20); doc.setFont("helvetica", "bold"); doc.text("Cost Estimate", 105, 20, { align: 'center' });
            doc.setFontSize(11); doc.setFont("helvetica", "normal");
            doc.text(`Cost estimate Nr.: ${estimateNr}`, 14, 35); doc.text(`Date: ${today}`, 148, 35);
            doc.text(`Dear ${customerName},`, 14, 50);
            doc.text("We thank you for your enquiry and would like to make the following offer:", 14, 57);

            const dynamicDescription = getDynamicDescription();
            doc.setFont("helvetica", "bold"); doc.text(dynamicDescription, 14, 67); doc.setFont("helvetica", "normal");

            const tableBody = [];
            let subtotal = 0;
            const costItems = [
                { label: 'Printing Cost', value: parseFloat(printingCostInput.value) || 0 }, 
                { label: 'Second Printing', value: parseFloat(secondCostInput.value) || 0 },
                { label: 'Paper Cost', value: parseFloat(paperCostInput.value) || 0 }, 
                { label: 'Lamination Cost', value: parseFloat(lamiCostInput.value) || 0 },
                { label: 'Binding Cost', value: parseFloat(bindingCostInput.value) || 0 }, 
                { label: 'Punching', value: parseFloat(punchingCostInput.value) || 0 },
                { label: 'Clips', value: parseFloat(clipsCostInput.value) || 0 }, 
                { label: 'Envelope Cost', value: parseFloat(envCostInput.value) || 0 },
                { label: 'Other Costs', value: parseFloat(otherMiscCostInput.value) || 0 }
            ];

            costItems.forEach((item) => {
                if (item.value > 0) {
                    tableBody.push([tableBody.length + 1, item.label, `₹ ${item.value.toFixed(2)}`]);
                    subtotal += item.value;
                }
            });
            
            const total = Math.ceil(subtotal / 50) * 50;

            doc.autoTable({
                head: [['Pos.', 'Description', 'Price']], body: tableBody, foot: [['', 'Total', `₹ ${total.toFixed(2)}`]],
                startY: 75, theme: 'grid',
                headStyles: { fillColor: [22, 160, 133], textColor: [255, 255, 255], halign: 'center' },
                footStyles: { fillColor: [230, 230, 230], textColor: [0, 0, 0], fontStyle: 'bold', halign: 'right' },
                columnStyles: { 0: { halign: 'center', cellWidth: 15 }, 1: { halign: 'left' }, 2: { halign: 'right' } },
                didDrawPage: (data) => {
                    doc.setFontSize(10); doc.setFont("helvetica", "normal");
                    const validUntil = new Date(); validUntil.setDate(validUntil.getDate() + 15);
                    doc.text(`This offer is valid until ${validUntil.toLocaleDateString('en-GB')}.`, 14, doc.internal.pageSize.height - 20);
                    doc.text("We hope you will approve and look forward to working with you.", 14, doc.internal.pageSize.height - 13);
                }
            });
            
            doc.save(`Cost-Estimate-${estimateNr}.pdf`);
        }

        // --- LOAD/DELETE/MODAL FUNCTIONS ---
        function loadEstimate(estimateKey) {
            const dataString = localStorage.getItem(estimateKey);
            if (dataString) {
                try {
                    const estimateData = JSON.parse(dataString);
                    allInputs.forEach(input => {
                        if (input.id && estimateData[input.id] !== undefined) {
                            input.type === 'checkbox' ? input.checked = estimateData[input.id] : input.value = estimateData[input.id];
                            if (input.tagName === 'SELECT') input.dispatchEvent(new Event('change'));
                        }
                    });
                    calculateGrandTotal(); 
                    closeModal();
                    alert(`Loaded estimate for "${estimateData['customer-name'] || estimateKey}"`);
                } catch (e) { alert("Failed to load estimate (corrupted data)."); console.error(e); }
            }
        }
        
        function deleteEstimate(estimateKey) {
            if (confirm(`Are you sure you want to delete estimate ${estimateKey}?`)) {
                localStorage.removeItem(estimateKey);
                alert("Estimate deleted successfully.");
                showPreviousEstimates(); 
            }
        }
        
        function showPreviousEstimates() {
            const estimates = Object.keys(localStorage).filter(key => key.startsWith('AOP')).sort();
            
            let listHtml = '<ul class="estimates-list">';
            if (estimates.length > 0) {
                estimates.forEach(key => {
                    let customerName = 'Unknown Customer';
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        if(data && data['customer-name']) customerName = data['customer-name'];
                    } catch(e) {}
                    listHtml += `<li class="estimate-item">
                                   <span class="estimate-name" data-key="${key}">${key}: ${customerName}</span>
                                   <button class="delete-estimate-btn" data-key="${key}" title="Delete estimate">✕</button>
                                 </li>`;
                });
            } else {
                listHtml += '<li>No saved estimates found.</li>';
            }
            listHtml += '</ul>';
            modalContainer.innerHTML = `<div class="modal-overlay active"><div class="modal-content"><button class="modal-close" title="Close">&times;</button><h2>Previous Estimates</h2>${listHtml}</div></div>`;
        }

        function showWeightCalculatorModal() {
            const modalHTML = `
                <div class="modal-overlay active">
                    <div class="modal-content">
                        <button class="modal-close" title="Close">&times;</button>
                        <h2>Paper Weight Calculator</h2>
                        <form id="paper-weight-form" class="form-grid form-grid-single-col" style="gap: 1rem;">
                            <div class="form-group">
                                <label for="calc-width">Sheet Width (inches)</label>
                                <input type="number" id="calc-width" value="23" required>
                            </div>
                            <div class="form-group">
                                <label for="calc-length">Sheet Length (inches)</label>
                                <input type="number" id="calc-length" value="36" required>
                            </div>
                            <div class="form-group">
                                <label for="calc-gsm">Paper Weight (GSM)</label>
                                <input type="number" id="calc-gsm" value="90" required>
                            </div>
                             <div class="form-group">
                                <label for="calc-sheets">Sheets per Ream</label>
                                <input type="number" id="calc-sheets" value="500" required>
                            </div>
                            <button type="submit" class="utility-btn" style="width: 100%; padding: 0.8rem; border-radius: 8px; font-size: 1rem;">Calculate</button>
                        </form>
                        <div id="weight-calculator-result" style="display: none;"></div>
                    </div>
                </div>`;
            modalContainer.innerHTML = modalHTML;
            
            document.getElementById('paper-weight-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const widthInches = parseFloat(document.getElementById('calc-width').value);
                const lengthInches = parseFloat(document.getElementById('calc-length').value);
                const gsm = parseFloat(document.getElementById('calc-gsm').value);
                const sheets = parseInt(document.getElementById('calc-sheets').value, 10);
                const resultDiv = document.getElementById('weight-calculator-result');
                
                if (isNaN(widthInches) || isNaN(lengthInches) || isNaN(gsm) || isNaN(sheets) || widthInches <= 0 || lengthInches <= 0 || gsm <= 0 || sheets <= 0) {
                    resultDiv.innerHTML = `<p class="result-label">Error</p><p class="result-value">Invalid Input</p>`;
                } else {
                    const widthMeters = widthInches * 0.0254;
                    const lengthMeters = lengthInches * 0.0254;
                    const areaMetersSq = widthMeters * lengthMeters;
                    const totalWeightGrams = (areaMetersSq * gsm) * sheets;
                    const totalWeightKg = totalWeightGrams / 1000;
                    resultDiv.innerHTML = `<p class="result-label">Total Ream Weight is:</p><p class="result-value">${totalWeightKg.toFixed(2)} kg</p>`;
                }
                resultDiv.style.display = 'block';
            });
        }
        
        function closeModal() { modalContainer.innerHTML = ''; }
        
        function populateDropdowns() {
            if (!appData.paperData) return;
            const hardcodedGsms = [170, 300, 350, 'DUPLEX'];
            let allGsm = [...new Set(appData.paperData.map(item => item.gsm))];
            
            hardcodedGsms.forEach(gsm => {
                if (!allGsm.includes(gsm)) {
                    allGsm.push(gsm);
                }
            });
            
            allGsm.sort((a,b) => {
                const aIsStr = isNaN(a), bIsStr = isNaN(b);
                if (aIsStr !== bIsStr) return aIsStr ? -1 : 1;
                return aIsStr ? a.localeCompare(b) : a - b;
            });
            
            const uniqueSizes = [...new Set(appData.paperData.map(item => item.size.toUpperCase()))].sort();
            paperSizeSelect.innerHTML = '<option value="">Select Size</option>' + uniqueSizes.map(s => `<option value="${s}">${s}</option>`).join('');
            const gsmOptions = '<option value="">Select GSM</option>' + allGsm.map(g => `<option value="${g}">${g}</option>`).join('');
            printingGsmSelect.innerHTML = gsmOptions;
            paperGsmSelect.innerHTML = gsmOptions;
        }
        
        function setupEventListeners() {
            modalContainer.addEventListener('click', (e) => {
                if(e.target.matches('.modal-overlay, .modal-close')) closeModal();
                if(e.target.matches('.estimate-name')) loadEstimate(e.target.dataset.key);
                if(e.target.matches('.delete-estimate-btn')) {
                    e.stopPropagation();
                    deleteEstimate(e.target.dataset.key);
                }
            });

            downloadPdfBtn.addEventListener('click', generatePDF);
            whatsappBtn.addEventListener('click', sendToWhatsApp);
            prevEstimatesBtn.addEventListener('click', showPreviousEstimates);
            openWeightCalculatorBtn.addEventListener('click', showWeightCalculatorModal);

            allCostInputs.forEach(input => input.addEventListener('input', calculateGrandTotal));
            
            [jobSizeSelect, quantityInput, fbCheck, formCheck, withoutPlateCheck, printingGsmSelect].forEach(el => {
                el.addEventListener('change', calculateAllCosts);
                el.addEventListener('input', calculateAllCosts);
            });
            
            [paperSizeSelect, paperGsmSelect, paperRateInput, gstCheckbox, paperSheetsInput].forEach(el => {
                el.addEventListener('change', calculatePaperCost);
                el.addEventListener('input', calculatePaperCost);
            });

            printingGsmSelect.addEventListener('change', () => syncGsm(printingGsmSelect, paperGsmSelect));
            paperGsmSelect.addEventListener('change', () => syncGsm(paperGsmSelect, printingGsmSelect));
        }
    });
    </script>
</body>
</html>
